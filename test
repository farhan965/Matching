


alter PROCEDURE [test].[LoadEmailsToStaging_T1]
    @MappingSchema NVARCHAR(128),
    @MappingTable NVARCHAR(128)
AS
BEGIN
    -- Constructing dynamic SQL query
    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
    WITH cte AS (
        SELECT distinct CT 
        FROM ' + @MappingSchema + '.' + @MappingTable + '
        WHERE [RecordType.DeveloperName] IN (''Ad'', ''Hc'', ''Ho'') and ct is not null),
    cte2 AS (
        SELECT 
            c.CT as CD,
            m.Id,
			m.LastModifiedDate
        FROM 
           cte c
        LEFT JOIN'
          + @MappingSchema + '.' + @MappingTable + '
        ON (
             c.CT = m.CT
            
            )),
 
    cte3 as (select * from cte2),
    cte4 as (SELECT CD, max(LastModifiedDate) as LastModifiedDate , max(Id) as ID FROM CTE3 group by CD)

	SELECT * into [Staging].[Mapping_Table_CRD] from CTE4;';

    -- Execute the dynamic SQL
    EXEC sp_executesql @SQL;
END;


GO


